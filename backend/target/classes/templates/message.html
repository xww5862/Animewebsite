<!doctype html>
<html lang="zh-CN">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>WilWil</title>

    <link rel="stylesheet" th:href="@{/static/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/static/css/style-starter.css}">
    <script th:src="@{/static/layui.js}"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/static/css/xcConfirm.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/layui.css}">
    <link rel="stylesheet" th:href="@{/static/css/message.css}">
    <style>
        .myButton1 {
            top: 79px;
            position: absolute;
            background-color: #df0e62;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            right: 321px;
        }

        .myButton1:hover {
            background-color: #127681; /* 鼠标悬停时的背景颜色 */
        }

        .myButton2 {
            top: 79px;
            position: absolute;
            background-color: #df0e62;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            right: 204px;
        }

        .myButton2:hover {
            background-color: #127681; /* 鼠标悬停时的背景颜色 */
        }

        .user-name-link{
            color: #df0e62;
        }
        .user-name-link:hover{
            color: #127681;
        }
    </style>
</head>

<body>

<!-- header -->
<header id="site-header" class="w3l-header fixed-top">
    <!--/nav-->
    <nav class="navbar navbar-expand-lg navbar-light fill px-lg-0 py-0 px-3">
        <div class="container">
            <h1>
                <a class="navbar-brand" th:href="@{/user/toIndex}">
                    WilWil </a>
            </h1>
            <button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                    data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                <!-- <span class="navbar-toggler-icon"></span> -->
                <span class="fa icon-expand fa-bars"></span>
                <span class="fa icon-close fa-times"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" th:href="@{/user/toIndex}">主页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">关于我们</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">联系我们</a>
                    </li>
                </ul>

                <!--/search-right-->
                <!--/search-right-->
                <div class="search-right">
                    <a href="#search" class="btn search-hny mr-lg-3 mt-lg-0 mt-4" title="search">搜索<span
                            class="fa fa-search ml-3" aria-hidden="true"></span></a>
                    <!-- search popup -->
                    <div id="search" class="pop-overlay">
                        <div class="popup">
                            <form th:action="@{/video/search}" method="post" class="search-box">
                                <input type="search" placeholder="Search your Keyword" name="videoTitle"
                                       required="required" autofocus="">
                                <button type="submit" class="btn"><span class="fa fa-search"
                                                                        aria-hidden="true"></span></button>
                            </form>
                            <div class="browse-items">
                                <h3 class="hny-title two mt-md-5 mt-4">WilWil搜索</h3>
                                <ul class="search-items">
                                    <li><a href="#">热血</a></li>
                                    <li><a href="#">恋爱</a></li>
                                    <li><a href="#">穿越</a></li>
                                    <li><a href="#">搞笑</a></li>
                                    <li><a href="#">治愈</a></li>
                                    <li><a href="#">校园</a></li>
                                </ul>
                            </div>
                        </div>
                        <a class="close" href="#close">×</a>
                    </div>
                    <!-- /search popup -->
                    <!--/search-right-->
                </div>


            </div>
            <!-- toggle switch for light and dark theme -->
            <div class="mobile-position">
                <nav class="navigation">
                    <div class="theme-switch-wrapper">
                        <label class="theme-switch" for="checkbox">
                            <input type="checkbox" id="checkbox">
                            <div class="mode-container">
                                <i class="gg-sun"></i>
                                <i class="gg-moon"></i>
                            </div>
                        </label>
                    </div>
                </nav>
            </div>
            <!-- //toggle switch for light and dark theme -->
            <!--<button type="button" class="btn btn-primary btn-lg active">登录</button>-->
            <div th:unless="${session.user}">
                <a th:href="@{/user/toLogin}" class="btn btn-primary btn-lg"
                   style="height: 38px;font-size: 14px;">登录</a>
            </div>
            <div th:if="${session.user}">
                <button class="layui-btn layui-btn-primary" id="demo4">
                    <span th:text="${session.user.userName}"></span>
                    <i class="layui-icon layui-icon-more-vertical layui-font-12">
                    </i>
                </button>
            </div>
        </div>
    </nav>
    <!--//nav-->
</header>
<!-- //header -->
<section style="margin-top: 100px;">
    <div style="margin-left: 200px;">
        <h2>消息中心</h2>
    </div>
    <button id="readAllBtn" class="myButton1">全部读取</button>
    <button id="deleteAllReadBtn" class="myButton2">清空已读</button>
    <div class="container">
        <div id="allMsgPage"></div>
    </div>
</section>
</body>

</html>
<script th:src="@{/static/js/jquery.min.js}"></script>
<script th:src="@{/static/js/xcConfirm.js}" type="text/javascript" charset="utf-8"></script>
<script th:src="@{/static/js/bootstrap.min.js}"></script>
<script th:src="@{/static/js/common.js}"></script>

<!-- responsive tabs -->
<script>

    layui.use(['upload', 'element', 'form', 'dropdown', 'util', 'layer'], function () {
        /*<![CDATA[*/
        var ctxPath = /*[[@{/}]]*/ '';
        /*]]>*/
        var dropdown = layui.dropdown
            , util = layui.util
            , layer = layui.layer
            , form = layui.form
            , element = layui.element
            , upload = layui.upload
            , $ = layui.jquery;
        form.on('submit(formDemo)', function (data) {
            layer.msg(JSON.stringify(data.field));
        });

        dropdown.render({
            elem: '#demo4'
            , trigger: 'hover'
            , data: [
                {
                    title: '修改信息'
                    , href: '/user/toUEditorUser'
                    , id: 97
                },
                {
                    title: '修改密码'
                    , href: '/user/editPassword'
                    , id: 98
                },
                {
                    title: '修改密保'
                    , href: '/user/ueditencryptedProblem'
                    , id: 99
                },
                {
                    title: '个人视频'
                    , href: '/user/toMyIndex'
                    , id: 100
                }, {
                    title: "消息中心"
                    , href: '/user/toMessage'
                    , id: 101
                }, {
                    title: '视频中心'
                    , href: '/video/toVideoCenter'
                    , id: 101
                }, {
                    title: '视频上传'
                    , href: '/video/toAddVideo'
                    , id: 102
                }, {
                    title: '退出'
                    , href: '/user/logout'
                    , id: 103
                }
            ]
        });
    })
</script>
<script th:src="@{/static/js/easyResponsiveTabs.js}"></script>
<script type="text/javascript">
    var userId = sessionStorage.getItem("userId");
    $(document).ready(function () {
        //Horizontal Tab
        $('#parentHorizontalTab').easyResponsiveTabs({
            type: 'default', //Types: default, vertical, accordion
            width: 'auto', //auto or any width like 600px
            fit: true, // 100% fit in a container
            tabidentify: 'hor_1', // The tab groups identifier
            activate: function (event) { // Callback function if tab is switched
                var $tab = $(this);
                var $info = $('#nested-tabInfo');
                var $name = $('span', $info);
                $name.text($tab.text());
                $info.show();
            }
        });

        // 一键消息已读功能
        $("#readAllBtn").click(function() {
            // 发起 Ajax 请求，将所有消息标记为已读
            $.ajax({
                url: "/Message/readAll?userId=" + userId,
                type: "GET",
                dataType: "JSON",
                success: function(data) {
                    window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.success, {
                        onOk: function() {
                            // 延迟执行刷新页面
                            setTimeout(function() {
                                location.reload();
                            }, 100);
                        }
                    });
                },
                error: function() {
                    // 处理错误情况
                    // 示例：显示错误提示
                    window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
                }
            });
        });


        //一键删除已读消息功能
        $(document).ready(function() {
            $("#deleteAllReadBtn").click(function() {
                // 发起 Ajax 请求，删除所有已读信息
                $.ajax({
                    url: "/Message/deleteAllReadBtn?userId="+userId,
                    type: "GET",
                    dataType: "JSON",
                    success: function(data) {
                        window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.success, {
                            onOk: function() {
                                // 延迟执行刷新页面
                                setTimeout(function() {
                                    location.reload();
                                }, 100);
                            }
                        });
                    },
                    error: function() {
                        // 处理错误情况
                        // 示例：显示错误提示
                        window.wxc.xcConfirm("删除失败", window.wxc.xcConfirm.typeEnum.error);
                    }
                });
            });
        });

    });


    $('#reload').click(function() {
        window.location.reload();
    });

    var allMsg_signal = false;

    $(document).ready(function() {
        $("#allMsgPage").show();
        myAjax("/Message/getMsgList", "allMsgPage", "allMsgPage", "All");
        allMsg_signal = true;``
    });
    function myAjax(url, showpage_id, id_identify_prefix, msgTypeName) {
        $.ajax({
            url : url + "?msgTypeName=" + msgTypeName,
            async : true,
            type : "get",
            dataType : "JSON",
            error : function() {
                window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
            },
            success : function(data) {
                // alert("成功");
                if (data.length==0){
                    var img = $('<img src="../static/img/pre_message.png" width="1000px" alt="author image" />')
                    img.appendTo($('#allMsgPage'))
                }
                $.each(data, function(i, val) {
                    // 在这里处理当前数组项的逻辑

                    var div1 = $('<div class="mydiv container-fluid"'+'id ="msg_'+id_identify_prefix+val.msgId+'" style="background-color: white;margin:5px 0;border: rgba(0,0,0,.125) solid 1px; "/>');
                    var divplus=$('<div class="container-fluid" style="padding:0; width:90%; float:left;"/>');
                    divplus.appendTo(div1);

                    var div11 = $('<div style="padding: 20px 10% 0 20px;"/>');
                    div11.appendTo(divplus);
                    var span1_div11 = $('<span/>');
                    span1_div11.appendTo(div11);
                    span1_div11.html(this.msgTitle);

                    var span2_div11 = $('<span style="margin-left: 10px;color: #CFCFCF;"/>');
                    span2_div11.appendTo(div11);
                    var date = (new Date(this.msgSendDate)).Format("yyyy-MM-dd hh:mm:ss");
                    span2_div11.html(date);

                    var div12 = $('<div style="padding: 6px 10% 16px 20px;text-indent:2em; "/>');
                    div12.appendTo(divplus);
                    var span1_div12 = $('<span />');
                    span1_div12.appendTo(div12);
                    span1_div12.html(this.msgContext);

                    var span2_div12 = $('<span/>');
                    span2_div12.appendTo(div12);

                    var a_span2_div12 = $('<a/>')

                    a_span2_div12.appendTo(span2_div12);


                    if (val.sendUser!=null){
                        var sendUser_userName = val.sendUser.userName;
                        var sendUser_userId = val.sendUser.userId;
                        if (sendUser_userName!=null&&sendUser_userId!=null){

                            // 创建用于显示 userName 和 userId 的 <div> 元素
                            var userDiv = $('<div class="user-info" />');
                            var userNameElement = $('<span class="user-name" />').text('发送者：');
                            var userNameValue = $('<a class="user-name-link" />')
                                .text(sendUser_userName)
                                .attr('href', '/user/toIndexOther?userId=' + sendUser_userId);

                            // 将 userNameElement、userNameValue 和 userIdElement 添加到 userDiv 中
                            userNameElement.appendTo(userDiv);
                            userNameValue.appendTo(userDiv);

                            // 将 userDiv 添加到合适的位置
                            userDiv.appendTo(div12);
                        }
                    }
                    var msg_id=this.msgId;

                    var dov_id="#msg_"+id_identify_prefix + val.msgId;


                    //未读的信息添加读取的事件
                    if (val.msgState.stateId == 6) {
                        a_span2_div12.html("   确认读取>>");
                        var tip = $('<div style="float:right;" '+'id ="msg_'+id_identify_prefix+'_del'+val.msgId+'" class="tip"/>');
                        tip.appendTo(div1);
                        a_span2_div12.click(function(){
                            a_span2_div12.html("   已读");
                            $.ajax({
                                url : "/Message/updateMsgState?msgId=" + msg_id,
                                async : true,
                                type : "get",
                                dataType : "JSON",
                                error : function() {
                                    window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
                                },
                                success : function(data) {
                                    tip.remove();
                                    //$(dov_id).remove();
                                    window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.success);

                                    a_span2_div12.html("   已读");
                                    var del_a=$('<a '+'id ="msg_'+id_identify_prefix+'_del'+val.msgId+'" class="del" href="#"/>');
                                    var del_span = $(' <span class="glyphicon glyphicon-remove "></span>');
                                    del_span.appendTo(del_a);
                                    del_a.appendTo(div1);

                                    var id="#msg_"+id_identify_prefix+val.msgId;
                                    var id_height = $(id).height();
                                    var meg_del="#msg_"+id_identify_prefix+"_del"+val.msgId;
                                    var meg_del_height = $(meg_del).height();
                                    $(meg_del).css("top",(id_height-meg_del_height)/2);
                                    $(window).resize(function() { // 当浏览器大小变化时
                                        id="#msg_"+id_identify_prefix+val.msgId;
                                        id_height = $(id).height();
                                        meg_del="#msg_"+id_identify_prefix+val.msgId;
                                        meg_del_height = $(meg_del).height();
                                        $(meg_del).css("top",(id_height-meg_del_height)/2);
                                    });

                                    del_a.click(function(){
                                        var r = confirm("亲，您确定取消该信息吗？")
                                        if(r==true){
                                            $.ajax({
                                                url : "/Message/delMsg?msgId=" + msg_id,
                                                async : true,
                                                type : "get",
                                                dataType : "JSON",
                                                error : function() {
                                                    window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
                                                },
                                                success : function(data) {
                                                    $(dov_id).remove();
                                                    //window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.success);
                                                }
                                            });
                                        }
                                    });
                                }

                            });

                        });
                    } else {
                        a_span2_div12.html("   已读");
                        var del_a=$('<a '+'id ="msg_'+id_identify_prefix+'_del'+val.msgId+'"  class="del" href="#"/>');
                        var del_span = $(' <span class="glyphicon glyphicon-remove "></span>');
                        del_span.appendTo(del_a);
                        del_a.appendTo(div1);
                        del_a.click(function(){
                            var r = confirm("亲，您确定取消该信息吗？")
                            if(r==true){
                                $.ajax({
                                    url : "/Message/delMsg?msgId=" + msg_id,
                                    async : true,
                                    type : "get",
                                    dataType : "JSON",
                                    error : function() {
                                        window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
                                    },
                                    success : function(data) {
                                        $(dov_id).remove();
                                        //window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.success);
                                    }
                                });
                            }
                        });
                    }
                    div1.appendTo("#" + showpage_id);

                    var id="#msg_"+id_identify_prefix+val.msgId;
                    var id_height = $(id).height();
                    var meg_del="#msg_"+id_identify_prefix+"_del"+val.msgId;
                    var meg_del_height = $(meg_del).height();
                    $(meg_del).css("top",(id_height-meg_del_height)/2);
                    $(window).resize(function() { // 当浏览器大小变化时
                        id="#msg_"+id_identify_prefix+val.msgId;
                        id_height = $(id).height();
                        meg_del="#msg_"+id_identify_prefix+val.msgId;
                        meg_del_height = $(meg_del).height();
                        $(meg_del).css("top",(id_height-meg_del_height)/2);
                    });
                });
            }
        })
    };




</script>
<!-- //responsive tabs -->
<!--/theme-change-->
<script th:src="@{/static/js/theme-change.js}"></script>
<!-- //theme-change-->
<!-- script for owlcarousel -->
<!-- Template JavaScript -->
<script th:src="@{/static/js/jquery.magnific-popup.min.js}"></script>



