<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>视频播放</title>
    <link rel="icon" th:href="@{/static/icons/icon.ico}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/static/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/index.css}"/>
    <link rel="stylesheet" th:href="@{/static/css/DPlayer.min.css}">
    <link th:href="@{/static/css/cover.css}" rel="stylesheet">
    <link th:href="@{/static/css/style2.css}" rel="stylesheet" type="text/css" media="all"/>
    <link rel="stylesheet" type="text/css" th:href="@{/static/css/xcConfirm.css}"/>
    <script th:src="@{/static/js/jquery.min.js}"></script>

    <script th:src="@{/static/js/bootstrap.min.js}"></script>

    <script th:src="@{/static/js/xcConfirm.js}" type="text/javascript"></script>
    <!-- include dplayer -->

    <script th:src="@{/static/js/DPlayer.min.js}"></script>

    <!--    <script src="https://www.jq22.com/jquery/jquery-3.3.1.js"></script>-->
    <style type="text/css">
        #submitButton {
            background-color: #805bc0;
            color: #fff;
        }
        .out{
            height: 28px;
            width: 70px;
            text-shadow: none;
            background-color: #b1bbf7;
            border: 1px solid #fff;
            color: #fff;
            display: inline-block;
            padding: 6px 12px;
            margin-bottom: 0;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.12857143;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            -ms-touch-action: manipulation;
            touch-action: manipulation;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background-image: none;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        #message-container {
            background-color: white;
            color: #805bc0;
            padding: 0px;
            font-size: 15px;
            font-weight: 800;
            font-family: fantasy;
        }
        .websitecolor {
            background-color: #fff;
        }

        img {
            cursor: pointer;
        }

        .hunfu{
            color: #91c0ff;
        }

        .css_userName{
            font-weight: bold;
            font-family: "YaHei Consolas Hybrid", Consolas, "微软雅黑", "Meiryo UI", "Malgun Gothic", "Segoe UI", "Trebuchet MS", Helvetica, "Monaco", courier, monospace;

        }
        .card-text{
            margin: 0;
            font-size: 25px;
            font-family: 华文行楷;
            color: #000;
        }
        .barrage .show div {
            color: black;
            position: absolute;
            right: 0;
            right: 658px;
            top: 500px;
            font-size: 20px;
            font-family: 华文行楷;
            width: 200px;
        }


        .mybtn:hover {
            background-color: #c2d8ef;
        }

        .messageCenter:hover {
            color: #000;
            text-decoration: none;
        }

        .messageCenter {
            color: #FFFFFF;
            text-decoration: none;
        }

        .dplayer-small {
            width: 400px;
            height: 220px;
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 9999;
            transition: all 0.5s ease-out;
        }


        .containerPi {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .card {
            margin-bottom: 1rem;
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 0.5rem;
        }

        .card-footer {
            padding: 0;
        }

        .form-control {
            border: 2px solid #805bc0;
        }

        .invalid-feedback {
            color: red;
            font-weight: 1000;
            font-family: fangsong;
            font-size: 15px;
        }

        .btn-primary {
            background-color: #805bc0;
            border-color: #805bc0;
            float: right;
        }

        .nav-tabs {
            margin-top: 10px;
        }

        .nav-link {
            color: #000;
            background-color: transparent;
            border-color: transparent;
        }

        .nav-link.active {
            color: pink;
            border-color: deeppink;
        }

        .tab-content {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .modal-title {
            color: #000;
        }

        .modal-content {
            background-color: #fff;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            justify-content: center;
        }

        .btn-secondary {
            width: 88px;
            color: white;
            border-color: #805bc0;
            background-color: #805bc0;
            padding: 3px 16px 5px;
            font-weight: 500;
            border: 0;
            border-radius: 0;
            font-family: 'Open Sans', sans-serif;
            margin: 0px 5px 0px 0px;
        }
        .btn-secondary:hover{
            color: white;
        }

        .myIndex_a {
            text-decoration: none;
            position: absolute;
            top: 18px;
            right: 580px;
            margin-bottom: 60px;
            text-align: center;
            font-weight: 500;
            color: white;
            font-family: "STCaiyun";
            font-size: 25px;
            text-shadow: 0 0 10px rgb(221, 76, 124), 0 0 20px rgb(221, 76, 124), 0 0 30px rgb(221, 76, 124), 0 0 40px rgb(221, 76, 124);
        }
        .myIndex_a:hover{
            text-decoration: none;
        }
</style>
    <!--修改模态框 出现的位置-->
    <style type="text/css">
        .modal.fade.in {
            top: 200px;
            margin: 0 auto;
        }
    </style>
</head>
<!--<span class="glyphicon glyphicon-home"></span>-->
<body>
<div class="container websitecolor" style="padding: 0;border: 1px solid black;">
    <div class="container row">
        <a class="myIndex_a" th:href="@{/user/toIndex}">返回主页</a>
        <div class="col-sm-3" style="display: flex;flex-direction:row;margin-top: 10px;float: left;">
            <img id="index_to" th:src="${session.curVideo.user.iconUrl}"
                 style="width:60px; height:60px; border-radius:50%;margin-left: 6px;"/>
            <div style="display: flex;flex-direction:column;margin-top: 4px;padding-left: 10px;">
                <div style="font-size: 18px;" th:text="${session.curVideo.user.userName}"></div>

                <!-- 用于标记当前用户观看视频上传者的ID -->
                <input type="hidden" id="focusedid" th:value="${session.curVideo.user.userId}">
                <!-- 访问用户的stateId    访问用户——就是登录用户   -->
                <input type="hidden" id="stateId" th:value="${session.user.stateId}">
                <!-- 访问用户的id          -->
                <input type="hidden" id="userId" th:value="${session.user.userId}">
                <div style="display: flex;flex-direction:row;width:auto;">
                    <div style="margin-top: 8px;" id="fanNum" th:text="${session.curVideo.user.fanNum}"></div>
                    <div style="width:100px; margin-left: 8px;margin-top: 8px;">粉丝数</div>
                </div>
            </div>
        </div>

        <div class="col-sm-3 row col-sm-offset-6 container"
             style="text-align: center;height: 30px;margin: 20px auto auto 0;padding:0; float: right;">
            <button type="button" id="focuson" class="col-sm-4 btn btn-default btn-sm mybtn" title="关注">
                <span class="focusClass glyphicon glyphicon-plus"></span> <span class="focusvalue">关注</span>
            </button>
            <button type="button" class="col-sm-4 btn btn-default btn-sm mybtn" title="私信" data-toggle="modal"
                    data-target="#privatemsg">
                <span class="glyphicon glyphicon-send"></span> 私信
            </button>
            <button type="button" class="col-sm-4 btn btn-default btn-sm mybtn" title="我的消息">
                <span class="glyphicon glyphicon-comment"></span><a class="messageCenter" th:href="@{/user/toMessage}">消息中心</a>
            </button>

        </div>
    </div>

    <div class="container-fluid row" style="margin: 10px 0;padding: 0;height: auto;">

        <!--
            描述：播放视频窗口
        -->
        <input type="hidden" id="videoId" th:value="${session.curVideo.videoId}">

        <div class="col-lg-9" style="margin-bottom: 30px;">
            <div style="width: 100%; display: block;height: auto">
                <div id="dplayer">
                </div>
            </div>
            <div class="barrage ">
                <div class="show">
                </div>
            </div>
            <div id="message-container">
                <div id="countdown-container">

                </div>
            </div>

        </div>
        <!--
            描述：视频信息
        -->
        <div class="col-lg-3">
            <table class="table table-condensed table-hover with-check"
                   style="word-break:break-all; ">
                <caption style="font-size: 18px; font-weight: bold;">视频信息</caption>
                <tbody class="row">
                <tr>
                    <td class="col-lg-4">名称</td>
                    <td class="col-lg-8" th:text="${session.curVideo.videoTitle}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4" style="width: 205px;height: 234px">描述</td>
                    <td class="col-lg-8" th:text="${session.curVideo.videoInfo}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">上传用户</td>
                    <td class="col-lg-8" th:text="${session.curVideo.user.userName}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">发布时间</td>
                    <td class="col-lg-8"
                        th:text="${#dates.format(session.curVideo.editDate,'yyyy:MM:dd hh:mm:ss')}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">视频类型</td>
                    <td class="col-lg-8" th:text="${session.curVideo.videoType.typeName}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">视频状态</td>
                    <td class="col-lg-8" th:text="${session.curVideo.videoState.stateName}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">即时评分</td>
                    <td class="col-lg-8" id="starNum"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">点赞</td>
                    <td class="col-lg-8" id="ppNum" th:text="${session.curVideo.ppNum}"></td>
                </tr>
                <tr>
                    <td class="col-lg-4">播放量</td>
                    <td class="col-lg-8" th:text="${session.curVideo.viewNum}"></td>
                </tr>
                </tbody>
            </table>
            <div class="container">
                <div class="row">
                    <button type="button" class="btn btn-default btn-sm dianzan" title="点赞">
                        <span class="dianzan glyphicon glyphicon-thumbs-up"></span><span class="dianzanvalue">点赞</span>
                    </button>
                    <button data-html="true" type="button" class="btn btn-default btn-sm pop" title="点评"
                            data-placement="bottom" data-content="

            <form id='commentedstarForm' action='#' method='post' >
                <div class='form-group'>
                    <select class='form-control' name='starNum'>
                        <option  selected='selected'>  请选择评星  </option>
                        <option value='1'>★</option>
                        <option value='2'>★★</option>
                        <option value='3'>★★★</option>
                        <option value='4'>★★★★</option>
                        <option value='5'>★★★★★</option>
                    </select>
                </div>
                <div class='form-group'>
                    <input type='hidden' name='userId'  id='userIdTwo' />
                </div>
                <div class='form-group'>
                    <input type='hidden' name='videoId' id='videoIdTwo'/>
                </div>
                <button id='submitButton' type='button' class='btn btn-default'>提交</button>
                <button class='out' type='reset' class='btn btn-default'>取消</button>
            </form>
            <script type='text/javascript'>
                $(document).ready(function(){
                    var videoId = $('#videoId').val();
                    var userId = $('#userId').val();
                    $('#userIdTwo').attr('value', userId);
                    $('#videoIdTwo').attr('value', videoId);
                });

                $('.out').click(function(){
                    $('.pop').popover('hide');
                });

                $('#submitButton').click(function(){
                    var formData = new FormData($('#commentedstarForm')[0]);
                    $.ajax({
                        type: 'post',
                        url: '/video/commented',
                        async: true,
                        data: formData,
                        dataType: 'JSON',
                        processData: false,
                        contentType: false,
                        success: function(result){
                            if(result.message == '点评成功'){
                                var starNum = $('#starNum').html();
                                var starNum2 = parseInt(starNum) + 1;
                                $('#starNum').html(starNum2);
                                window.wxc.xcConfirm(result.message, window.wxc.xcConfirm.typeEnum.success);
                            } else {
                                window.wxc.xcConfirm(result.message, window.wxc.xcConfirm.typeEnum.warning);
                            }
                        }
                    });
                });
            </script>
        ">
                    <span class="glyphicon glyphicon-comment"></span>点评
                    </button>
                    <button id="c_button" type="button" class="btn btn-default btn-sm" title="收藏">
                        <span class="c_class glyphicon glyphicon-star-empty"></span><span class="c_value">收藏</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="containerPi" style="margin-top: 10px;margin-bottom: 10px">
        <div class="card mb-3 shadow-lg p-3 bg-white rounded" id="articleCard">
            <div class="card-footer">
                <form class="mb-3">
                    <div class="form-group">
                    <textarea class="form-control border border-primary" aria-label="With textarea"
                              id="videoCommentContent"></textarea>
                        <div class="invalid-feedback">
                            评论长度不能大于100也不能为空
                        </div>
                    </div>
                    <div class="form-group">
                        <a href="#" class="btn btn-primary disabled" role="button" id="addVideoComment" style="float: right">发表评论</a>
                    </div>
                </form>

                <ul class="nav nav-tabs" id="myTab" role="tablist" style="margin-top: 10px">
                    <li class="nav-item">
                        <a class="nav-link active" id="home-tab" data-toggle="tab"  href="#commentsLists" role="tab"
                           aria-controls="home" aria-selected="true" onclick="toggleComments()">评论</a>
                    </li>
                </ul>
                <div class="tab-content shadow-lg" id="myTabContent" style="display: none;">
                    <div class="tab-pane fade shows active" id="commentsLists" role="tabpanel" aria-labelledby="home-tab">
                    </div>
                </div>


            </div>
        </div>
    </div>



    <!-- Modal -->
    <div class="modal fade" id="ReplyComment" tabindex="-1" role="dialog" aria-labelledby="ReplyCommentTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ReplyCommentTitle">回复</h5>
                    <button type="button" class="close" id="closeRetrun" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="mb-3">
                        <div class="form-group">
                    <textarea class="form-control border border-primary" aria-label="With textarea"
                              id="ReplyCommentContent"></textarea>
                            <div class="invalid-feedback">
                                评论长度不能大于100也不能为空
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="ReplyCommentSend">发表回复</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>




    <div class="container-fluid">

        <div style="font-size: 20px; font-weight: bold; margin-top: 35px;">视频推荐</div>

        <div class="container-fluid row" style="margin: 0;padding: 0;">

            <div id="videoList"></div>
        </div>
    </div>
</div>



<!--
    描述：网页底部
-->
<footer class="container footer">
    <p>Web template built for
        <a href="#">Website</a> by
        <a href="#">@Steve.Xu</a>.</p>
</footer>
<div class="modal fade" id="privatemsg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 50%; height: auto;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="myModalLabel">用户私信</h4>
            </div>
            <div class="modal-body">
                <form id="msgForm" action="#" class="form-horizontal" role="form">

                    <input type="hidden" name="receiveUserId" th:value="${session.curVideo.user.userId}">
                    <input type="hidden" name="msgTypeId" value="1">

                    <div class="form-group">
                        <label class="col-sm-2 control-label">主 题</label>
                        <div class="col-sm-10">
<!--                            placeholder="输入主题"-->
                            <input type="text" name="msgTitle" class="form-control" value="私信">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">内 容</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" name="msgContext" style="resize:none;" rows="5"
                                      placeholder="输入内容"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="closeMsg">关闭</button>
                <button type="button" class="btn btn-primary" id="sendMsg">发送</button>
            </div>
        </div>
        <!-- /.modal-content -->

    </div>
    <!-- /.modal-dialog -->
</div>

<script th:src="@{/static/js/common.js}"></script>
<!--  -实现点击就显示，再点击一次就隐藏--------   -->
<script>
    var commentsVisible = false;

    function toggleComments() {

        var commentsContent = document.getElementById("myTabContent");
        if (commentsVisible) {
            commentsContent.style.display = "none";
            commentsVisible = false;
        } else {
            commentsContent.style.display = "block";
            commentsVisible = true;
        }
    }
</script>
<script>

    //即时评分数量
    $(document).ready(
        function(){
            var videoId = $("#videoId").val();
            $.ajax({
                url: "/commentstar/getcommentstar_count",
                async: false,
                data: {"videoId": videoId},
                dataType: "JSON",
                error: function (data) {
                    window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
                },
                success: function (data) {
                        var starNum = data;
                        $('#starNum').html(starNum);
                }
            })
        }
    );


    $(function () {
        var a = $(".videodiv").width();
        $('.videodiv').css('height', a * 0.57);
    });
    $(window).resize(function () {          //当浏览器大小变化时
        var a = $(".videodiv").width();
        $('.videodiv').css('height', a * 0.57);
    });


    //Dplayer视频资源加载
    $(document).ready(function () {
        var videoId = $('#videoId').val();
        var userId = $('#userId').val();


        $(document).ready(function () {
            $.ajax({
                url: "/order/getNowStateId",
                async: false,
                type:"get",
                data:{"userId": userId},
                dataType: "JSON",
                error: function (data) {
                    console.log('失败了！！！！！！！！！！！！');
                },
                success: function (data) {
                    var stateId = data.stateId;
                    $.ajax({
                        url: "/video/getVideoUrlByUserId",
                        async: true,
                        type: "get",
                        data: {"videoId": videoId},
                        dataType: "JSON",
                        error: function () {
                            window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
                        },
                        success: function (data1) {
                            //弹幕功能
                            if (data1.videoTypeId == 6 && stateId != 2) {
                                //需要试看
                                // 创建Dplayer实例
                                const dp = new DPlayer({
                                    container: document.getElementById('dplayer'),
                                    video: {
                                        url: data1.videoUrl,
                                        type: 'auto',
                                    }, danmaku: {
                                        //视频id
                                        id: videoId,
                                        //用户id
                                        user: userId,
                                        api: 'http://localhost:8081/barrage/'
                                    }
                                });
                                // 获取提示信息容器
                                var messageContainer = document.getElementById('message-container');
                                // 获取倒计时容器
                                var countdownContainer = document.getElementById('countdown-container');
                                // 设置试看时间（30秒）
                                var previewTime =  30;

                                // 监听视频加载完成事件
                                dp.on('loadedmetadata', function () {
                                    // 获取视频总时长
                                    var duration = dp.video.duration;

                                    // 监听视频播放时间更新事件
                                    dp.on('timeupdate', function () {
                                        // 计算剩余试看时间
                                        var remainingTime = previewTime - dp.video.currentTime;
                                        // 取整得到整数秒
                                        var seconds = Math.floor(remainingTime);
                                        // 更新倒计时显示
                                        countdownContainer.innerHTML = seconds;

                                        // 如果播放时间超过试看时间，暂停视频
                                        if (dp.video.currentTime >= previewTime) {
                                            dp.pause();
                                            messageContainer.style.display = 'none';
                                            window.wxc.xcConfirm("试看结束,如要继续观看，请成为大会员", window.wxc.xcConfirm.typeEnum.warning);
                                        } else {
                                            // 显示提示信息
                                            messageContainer.style.display = 'block';
                                            messageContainer.innerHTML = "您只能观看 " + seconds + " 秒";
                                        }
                                    });

                                    // 监听播放按钮点击事件
                                    dp.on('play', function () {
                                        // 如果视频已经播放完毕，重新播放视频
                                        if (dp.video.currentTime >= duration) {
                                            dp.seek(0);
                                        }
                                    });
                                });
                            } else {
                                //正常观看

                                const dp = new DPlayer({
                                    container: document.getElementById('dplayer'),
                                    autoplay: true,
                                    screenshot: true,
                                    logo: '../static/img/blogo.png',
                                    video: {
                                        url: data1.videoUrl
                                    },
                                    danmaku: {
                                        //视频id
                                        id: videoId,
                                        //用户id
                                        user: userId,
                                        api: 'http://localhost:8081/barrage/'
                                    }
                                });
                            }

                            let isPlayerSmall = false;
                            const playerElement = document.getElementById('dplayer');
                            window.addEventListener('scroll', function() {
                                const scrollY = window.scrollY || window.pageYOffset;
                                if (scrollY > 500 && !isPlayerSmall) {
                                    playerElement.classList.add('dplayer-small');
                                    isPlayerSmall = true;
                                } else if (scrollY <= 500 && isPlayerSmall) {
                                    playerElement.classList.remove('dplayer-small');
                                    isPlayerSmall = false;
                                }
                            });
                        }
                    });

                }
            });
        });


    });

    //在线人数功能实现
    $(document).ready(function () {
        var videoId = $('#videoId').val();
        if (typeof (WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        } else {
            index = new WebSocket("ws://localhost:8081/BarrageWebSocket?videoId=" + videoId);
            //打开事件
            index.onopen = function () {
                console.log("Socket 已打开");
                //index.send("这是来自客户端的消息" + location.href + new Date());
            };
            //获得消息事件
            index.onmessage = function (msg) {
                var text = msg.data
                var div = "<div>" + text + "</div>";
                $(".show").append(div);
            };
            //关闭事件
            index.onclose = function () {
                console.log("Socket已关闭");
            };
            //发生了错误事件
            index.onerror = function () {
                alert("Socket发生了错误");
            };
        }
    });

    //点评的切换事件
    $(".pop").click(function () {
        $(".pop").popover("show");
    });


    //视频推荐，待改进
    $(document).ready(function () {
        $.ajax({
            url: "/video/getRecommendVideo",
            async: true,
            type: "get",
            dataType: "JSON",
            error: function () {
                window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
            },
            success: function (data1) {
                var videoId = $('#videoId').val();
                console.log(data1)
                $.each(data1, function (i, val) {
                    if (videoId!=this.videoId){//当前的视频不用推荐了
                        var div121 = $('<div class="col-sm-4" style="width: 379px;height: 559px"/>');
                        var div1211 = $('<div class="view view-first" style="width: 100%; height: auto;"/>');
                        div1211.appendTo(div121);

                        var div1211_a = $('<a class="videodiv2" style="width: 100%; display: block;"/>');
                        div1211_a.appendTo(div1211);

                        var div1211_a_img = $('<img class="img-responsive" alt="" style="width: 349px; height: 498px;"/>');
                        div1211_a_img.attr("src", this.thunmbnailUrl);
                        div1211_a_img.appendTo(div1211_a);

                        var div121_div = $('<div class="tab_desc"/>');
                        div121_div.appendTo(div121);

                        var div121_div_a = $('<a href="">现在观看</a>');
                        div121_div_a.attr('href', "/video/videoPlay?=videoId=" + this.videoId)
                        div121_div_a.appendTo(div121_div);

                        div121.appendTo($("#videoList"));

                        div121_div_a.click(function () {
                            window.open("/video/videoPlay?videoId=" + val.videoId);
                        });
                    }
                });
            }
        });
    });



    //视频点赞
    $('.dianzan').click(
        function () {
            var videoId = $('#videoId').val();
            $.ajax({
                url: "/video/thumbsUp",
                async: false,
                data: {"videoId": videoId},
                dataType: "JSON",
                error: function (data) {
                    window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
                },
                success: function (data) {
                    if (data.message != "点赞成功") {
                        window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.warning);
                    } else {
                        var ppNum = $('#ppNum').html();
                        var ppNum2 = parseInt(ppNum) + 1;
                        $('#ppNum').html(ppNum2);
                        $('.dianzanvalue').html("已点赞");
                    }
                    $('.dianzan').unbind('click');
                }
            })
        }
    );
    //点击图片到别人的主页
    $(document).ready(function() {
        const image = document.getElementById('index_to');
        var clicked_userId = $('#focusedid').val();
        var userId = $('#userId').val();

        image.addEventListener('click', function() {
            // 条件判断，根据 clicked_userId 和 userId 进行页面跳转
            if (clicked_userId === userId) {
                // clicked_userId 与 userId 相等，跳转到我的主页
                window.location.href = '/user/toMyIndex';
            } else {
                // clicked_userId 与 userId 不相等，跳转到他人的主页
                window.location.href = '/user/toIndexOther?userId='+clicked_userId;
            }
        });
    });

    //判断用户是否已关注
    $(document).ready(
        function () {
            var focusedId = $('#focusedid').val();
            $.ajax({
                url: "/focus/focusVerify",
                async: false,
                type: "post",
                data: {"focusedId": focusedId},
                dataType: "JSON",
                error: function (data) {
                    window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
                },
                success: function (data) {
                    if (data.message == "已关注") {

                        $('.focusClass').removeClass("glyphicon-plus");
                        $('.focusClass').addClass('glyphicon-ok-circle');
                        $('.focusvalue').html("已关注");
                    } else if (data.message == "未关注") {
                        $('#focuson').click(
                            function () {
                                //var focusedId = $('#focusedid').val();
                                $.ajax({
                                    url: "/focus/focusOn",
                                    async: false,
                                    type: "post",
                                    data: {"focusedId": focusedId},
                                    dataType: "JSON",
                                    error: function (data) {
                                        window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
                                    },
                                    success: function (data) {

                                        if (data.message == "关注成功") {

                                            $('.focusClass').removeClass("glyphicon-plus");
                                            $('.focusClass').addClass('glyphicon-ok-circle');
                                            $('.focusvalue').html("已关注");
                                            fensiup();
                                        } else {
                                            window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.warning);
                                        }
                                    }
                                })
                            }
                        );
                    }
                }
            })
        }
    );

    //判断视频是否已经收藏
    $(document).ready(
        function () {
            var videoId = $('#videoId').val();
            $.ajax({
                url: "/collection/vertifyIfCollection",
                async: false,
                type: "post",
                data: {"videoId": videoId},
                dataType: "JSON",
                error: function (data) {
                    window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
                },
                success: function (data) {
                    if (data.message == "已收藏") {
                        $('.c_class').removeClass("glyphicon-star-empty");
                        $('.c_class').addClass('glyphicon-star');
                        $('.c_value').html("已收藏");
                    } else if (data.message == "未收藏") {
                        //未收藏就添加收藏事件
                        $('#c_button').click(
                            function () {
                                $.ajax({
                                    url: "/collection/addCollection",
                                    async: false,
                                    type: "post",
                                    data: {"videoId": videoId},
                                    dataType: "JSON",
                                    error: function (data) {
                                        window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
                                    },
                                    success: function (data) {
                                        if (data.message == "收藏成功") {
                                            $('.c_class').removeClass("glyphicon-star-empty");
                                            $('.c_class').addClass('glyphicon-star');
                                            $('.c_value').html("已收藏");
                                            //alert("收藏成功");
                                        } else {
                                            window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.warning);
                                        }
                                    }
                                })
                            }
                        );
                    }
                }
            })
        }
    );


    //粉丝数量+1
    function fensiup() {
        var focusedId = $('#focusedid').val();
        $.ajax({
            url: "/focus/fensiup",
            async: false,
            data: {"focusedId": focusedId},
            dataType: "JSON",
            error: function (data) {
                window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
            },
            success: function (data) {

                if (data.message == "粉丝加一成功") {
                    var fanNum = $('#fanNum').html();
                    var fanNum2 = parseInt(fanNum) + 1;
                    $('#fanNum').html(fanNum2);
                }

            }
        })

    }

    //私信功能+屏蔽
    $("#sendMsg").click(function () {
        var focusedId = $('#focusedid').val();
        $.ajax({
            type: "get",
            url: "/block/getuserList",
            data:{userId:sessionStorage.getItem("userId")},
            async: true,
            dataType: "JSON",
            error: function (data) {
                window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.error);
            },
            success: function (data) {
                //关闭按钮
                var closeButton = document.getElementById('closeMsg');

                var flag = true;
                for (var i = 0; i < data.length; i++) {
                    var user_blocked = data[i].userId;
                    if (focusedId==user_blocked){
                        //被屏蔽的情况
                        flag=false;
                        window.wxc.xcConfirm("您已被对方屏蔽，消息无法被对方接受", window.wxc.xcConfirm.typeEnum.warning);
                        break;
                    }
                }

                //flag==true,没有被屏蔽,则执行发送消息代码
               if (flag==true){
                   $.ajax({
                       type: "post",
                       url: "/Message/addLetter",
                       async: true,
                       data: $('#msgForm').serialize(),
                       dataType: "JSON",
                       error: function (data) {
                           window.wxc.xcConfirm("发送失败", window.wxc.xcConfirm.typeEnum.error);
                       },
                       success: function (result) {
                           window.wxc.xcConfirm(result.message, window.wxc.xcConfirm.typeEnum.success);
                           closeButton.click();
                       }//success:function
                   });//ajax
               }

            }//success:function
        });//ajax

    });


    //评论与回复提醒功能
    function Notification(url, method, msgTitle, msgContext, receiveUserId, msgTypeId) {
        var data = {
            msgTitle: msgTitle,
            msgContext: msgContext,
            receiveUserId: receiveUserId,
            msgTypeId: msgTypeId
        };

        $.ajax({
            url: url,
            method: method,
            data: data,
            dataType: "JSON",
            error: function() {
                alert("发送通知失败");
            },
            success: function(response) {
                // 处理通知发送成功后的逻辑
                console.log('评论消息通知已发送成功！！！！！！！！！！！！！！！');
            }
        });
    }

    //-------------------------------评论与回复功能分割线--------------------------------------------------


    //得到回复
    function getReplyComments(replyCommentList){
        var appendHtml='';
        for(var i in replyCommentList){
            var replyCom=replyCommentList[i];
            console.log(replyCom,'replyCom里面');
            var createTime = (new Date(replyCom.createTime)).Format("yyyy-MM-dd hh:mm:ss");
            appendHtml=appendHtml+'<div class="card">\n' +
                '<div class="row no-gutters">\n' +
                '<div class="card-body">\n' +
                '<h5 class="card-title"><img class="rounded-circle" src="'+replyCom.iconUrl+'" style="height: 30px;width: 30px;"/>\n' +
                '<span class="css_userName">'+replyCom.userName+'</span>'+'<span class="hunfu">'+'  回复了  '+'</span>'+'<span class="css_userName">'+replyCom.repliedUserName+'<span/>'+'<small class="text-muted" style="float: right">'+createTime+'</small></h5>\n' +
                '<p class="card-text">' +replyCom.content+
                '</p><a href="javascript:showReplyCommentDialog('+replyCom.commentId+','+replyCom.replyUserId+');">回复</a>' +
                '</div>' +
                '</div>' +
                '</div>';
        }
        return appendHtml;
    }

    // 获取评论并更新评论列表
    function getAndRenderComments() {
        var videoId = $('#videoId').val();
        $.ajax({
            url: "/comment/getComments",
            type: "POST",
            data: {
                videoId: videoId
            },
            success: function (data) {
                console.log(data);
                if (data) {
                    var appendHtml = '';
                    for (var i = 0; i < data.length; i++) {
                        var comments = data[i];
                        var createTime = new Date(comments.createTime).Format("yyyy-MM-dd hh:mm:ss");
                        appendHtml += '<div class="card">\n' +
                            '<div class="row no-gutters">\n' +
                            '<div class="card-body">\n' +
                            '<h5 class="card-title"><img class="rounded-circle" src="' + comments.user.iconUrl + '" style="height: 30px;width: 30px;"/>\n' +
                            '<span class="css_userName">'+comments.user.userName+'<span/>' + '<small class="text-muted" style="float: right">' + createTime + '</small></h5>\n' +
                            '<p class="card-text">' + comments.content +
                            '</p><a href="javascript:showReplyCommentDialog(' + comments.commentId + ',' + comments.commentUserId + ');">回复</a>' +
                            getReplyComments(comments.replyList) +
                            '</div>' +
                            '</div>' +
                            '</div>';
                    }
                    $("#commentsLists").html(appendHtml);
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
            }
        });
    }

    // 页面加载完成后获取评论并渲染
    $(document).ready(function () {
        getAndRenderComments();
    });

    // 添加评论按钮点击事件监听器
    $("#addVideoComment").click(function () {
        var commentContent = $("#videoCommentContent").val();
        var videoId = $('#videoId').val();
        var userId = $('#userId').val();
        var focusedId = $('#focusedid').val();
        if (commentContent != "" && commentContent.length <= 100) {
            var comment = {
                videoId: videoId,
                commentUserId:userId,
                content: commentContent
            };

            $.ajax({
                url: "/comment/addComment",
                type: "post",
                data: comment,
                dataType: "JSON",
                success: function (data) {
                    // window.wxc.xcConfirm("成功", window.wxc.xcConfirm.typeEnum.success);
                    console.log("评论成功！！！！！！！！！！！！！！！！！！！！！！");
                    // 清空textarea的内容
                    $("#videoCommentContent").val('');
                    // 重新获取并渲染评论
                    getAndRenderComments();
                    //给对方发送评论的通知消息
                    Notification("/Message/addLetter","post","评论提醒",commentContent,focusedId,"6");
                },
                error: function (xhr, status, error) {
                    window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
                    console.log("请求失败:", error);
                }
            });
        }
    });






    $("#videoCommentContent").bind("input propertychange", function () {
        var commentContent = $("#videoCommentContent").val().trim();
        if (commentContent.length <= 100&& commentContent !="") {
            if ($("#videoCommentContent").hasClass("is-invalid")) {
                $("#videoCommentContent").removeClass("is-invalid");
            }
            if($("#addVideoComment").hasClass("disabled"))
                $("#addVideoComment").removeClass("disabled");
        } else {
            if (!$("#videoCommentContent").hasClass("is-invalid")) {
                $("#videoCommentContent").addClass("is-invalid");
            }
            if(!$("#addVideoComment").hasClass("disabled"))
                $("#addVideoComment").addClass("disabled");
        }
    });
    $("#ReplyCommentContent").bind("input propertychange", function () {
        var replycContent = $("#ReplyCommentContent").val().trim();
        if (replycContent.length <= 100&&replycContent!="") {
            if ($("#ReplyCommentContent").hasClass("is-invalid")) {
                $("#ReplyCommentContent").removeClass("is-invalid");
            }
            if($("#ReplyCommentSend").hasClass("disabled"))
                $("#ReplyCommentSend").removeClass("disabled");
        } else {
            if (!$("#ReplyCommentContent").hasClass("is-invalid")) {
                $("#ReplyCommentContent").addClass("is-invalid");
            }
            if(!$("#ReplyCommentSend").hasClass("disabled"))
                $("#ReplyCommentSend").addClass("disabled");
        }
    });


    //增加回复
    $("#ReplyCommentSend").click(function () {
        var replycContent = document.getElementById("ReplyCommentContent").value;
        if(replycContent!=""&&replycContent.length<=100){
            addReplyComment();
        }
    });
    var commentIdCurrent,repliedUserIdCurrent;
    function addReplyComment() {
        var videoId = $('#videoId').val();
        var userId = $('#userId').val();
        var reply = {
            videoId:videoId,
            replyUserId:userId,
            commentId:commentIdCurrent,
            repliedUserId:repliedUserIdCurrent,
            content:$("#ReplyCommentContent").val()
        };
        $.ajax({
            url: "/reply/addReplyComment",
            async: false,
            type:"post",
            data: reply,
            dataType: "JSON",
            error: function (data) {
                window.wxc.xcConfirm("失败", window.wxc.xcConfirm.typeEnum.error);
            },
            success: function (data) {
                // window.wxc.xcConfirm("成功", window.wxc.xcConfirm.typeEnum.success);

                // 清空textarea的内容
                $("#ReplyCommentContent").val('');

                // 模拟取消按钮的点击动作
                $("#closeRetrun").click();

                // 重新获取并渲染评论
                getAndRenderComments();

                //给对方发送回复的通知消息
                Notification("/Message/addLetter","post","回复提醒",reply.content,reply.repliedUserId,"6");
                console.log("回复成功！！！！！！！！！！！！！！！！！！！！！！")
            }
        })
    }

    //显示回复框
    function showReplyCommentDialog(commentId,repliedUserId) {
        commentIdCurrent=commentId;
        repliedUserIdCurrent=repliedUserId;
        $("#ReplyComment").modal("show");
    }




</script>
</body>
</html>